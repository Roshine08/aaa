<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Battle.net Authenticator</title>
<link rel="icon" href="logo.png" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700;900&display=swap">

<style>
  :root{
    --bg-dark:#05060b;
    --panel-dark:rgba(11,16,24,.58);
    --panel2-dark:rgba(11,16,24,.42);
    --border-dark:rgba(130,170,255,.14);
    --text-dark:#e6f0ff;
    --muted-dark:#8a97b6;
    --accent-dark:#29b6ff;

    --bg-light:#171920;
    --panel-light:rgba(255,255,255,.08);
    --panel2-light:rgba(255,255,255,.06);
    --border-light:rgba(0,0,0,.22);
    --text-light:#e4e7f5;
    --muted-light:#7b849c;
    --accent-light:#3aa3ff;

    --bg:var(--bg-dark);
    --panel:var(--panel-dark);
    --panel2:var(--panel2-dark);
    --border:var(--border-dark);
    --text:var(--text-dark);
    --muted:var(--muted-dark);
    --accent:var(--accent-dark);

    --blur: 14px;
    --radius: 22px;
    --shadow: 0 22px 70px rgba(0,0,0,.55);
  }

  html[data-theme="dark"]{
    --bg:var(--bg-dark);
    --panel:var(--panel-dark);
    --panel2:var(--panel2-dark);
    --border:var(--border-dark);
    --text:var(--text-dark);
    --muted:var(--muted-dark);
    --accent:var(--accent-dark);
  }
  html[data-theme="light"]{
    --bg:var(--bg-light);
    --panel:var(--panel-light);
    --panel2:var(--panel2-light);
    --border:var(--border-light);
    --text:var(--text-light);
    --muted:var(--muted-light);
    --accent:var(--accent-light);
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family:"Titillium Web",system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background: radial-gradient(900px 520px at 18% 12%, rgba(41,182,255,.16), transparent 55%),
                radial-gradient(760px 480px at 86% 18%, rgba(58,163,255,.12), transparent 60%),
                radial-gradient(980px 560px at 50% 90%, rgba(41,182,255,.08), transparent 60%),
                linear-gradient(180deg, #05060b 0%, #02030a 100%);
    overflow-x:hidden;
  }
  html[data-theme="light"] body{
    background: radial-gradient(900px 520px at 18% 12%, rgba(58,163,255,.14), transparent 55%),
                radial-gradient(760px 480px at 86% 18%, rgba(58,163,255,.10), transparent 60%),
                linear-gradient(180deg, #171920 0%, #0f1118 100%);
  }

  body::before{
    content:"";
    position:fixed;
    inset:-20%;
    pointer-events:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    opacity:.07;
    mix-blend-mode:overlay;
    transform:translateZ(0);
  }

  .container{
    width:min(980px, 92vw);
    margin:0 auto;
  }

  /* Top nav (same feel as homepage) */
  .nav{
    position:sticky;
    top:0;
    z-index:50;
    padding:14px 0;
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    background: linear-gradient(180deg, rgba(0,0,0,.32), rgba(0,0,0,0));
  }
  .nav-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .brand img{
    width:40px;height:40px;border-radius:16px;
    box-shadow:0 12px 36px rgba(0,0,0,.45);
  }
  .brand .title{
    font-weight:900;
    letter-spacing:.06em;
    font-size:15px;
    white-space:nowrap;
  }
  .brand .sub{
    margin-top:2px;
    font-size:12px;
    color:var(--muted);
    line-height:1.25;
    max-width:70ch;
  }

  .controls{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .pill{
    height:36px;
    padding:0 14px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--panel2);
    color:var(--text);
    font-size:13px;
    font-weight:800;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
    text-decoration:none;
    box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
  }
  .pill:hover{
    transform:translateY(-1px);
    box-shadow: 0 14px 40px rgba(0,0,0,.35), 0 0 18px rgba(41,182,255,.18);
    background:rgba(0,0,0,.18);
    border-color:rgba(41,182,255,.26);
  }

  .lang-select{
    appearance:none;
    -moz-appearance:none;
    -webkit-appearance:none;
    border:none;
    background:transparent;
    padding:0 18px;
    text-align:center;
    cursor:pointer;
  }
  .lang-select option{ background:#050b16; color:#e8eefc; }
  html[data-theme="light"] .lang-select option{ background:#1a1d26; color:#e4e7f5; }

  /* Main panel */
  .main{
    padding: 16px 0 48px;
    display:flex;
    justify-content:center;
  }

  .panel{
    width:min(720px, 100%);
    border-radius: calc(var(--radius) + 10px);
    border:1px solid var(--border);
    background: var(--panel);
    box-shadow: var(--shadow);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    overflow:hidden;
    position:relative;
    padding: clamp(18px, 2.6vw, 34px);
  }

  .panel::before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background: linear-gradient(135deg, rgba(41,182,255,.18), rgba(58,163,255,.10), transparent 60%);
    opacity:.85;
  }
  .panel::after{
    content:"";
    position:absolute;
    left:-25%;
    top:-45%;
    width:150%;
    height:150%;
    background:linear-gradient(90deg, transparent, rgba(41,182,255,.10), transparent);
    transform:rotate(10deg);
    animation:sweep 8.5s linear infinite;
    opacity:.25;
    pointer-events:none;
  }
  @keyframes sweep{
    0%{ transform:translateX(-35%) rotate(10deg); opacity:0; }
    10%{ opacity:.25; }
    70%{ opacity:.12; }
    100%{ transform:translateX(35%) rotate(10deg); opacity:0; }
  }

  .panel-inner{ position:relative; z-index:1; }

  .title-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:18px;
  }
  .title-left{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .title-left .t{
    font-weight:900;
    letter-spacing:.04em;
    font-size:16px;
    white-space:nowrap;
  }

  .code{
    text-align:center;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: clamp(44px, 7vw, 76px);
    font-weight:900;
    letter-spacing: clamp(3px, .6vw, 7px);
    margin: 22px 0 12px;
  }

  .hint{
    text-align:center;
    font-size:13px;
    color:var(--muted);
    margin-bottom:14px;
  }

  .barwrap{
    height:12px;
    background:rgba(255,255,255,.08);
    border-radius:999px;
    overflow:hidden;
  }
  html[data-theme="light"] .barwrap{ background:rgba(0,0,0,.18); }

  .bar{
    height:100%;
    width:0%;
    background:var(--accent);
    background-image:linear-gradient(90deg,
      rgba(255,255,255,.35),
      rgba(255,255,255,.92),
      rgba(255,255,255,.35));
    background-size:200% 100%;
    animation:stripe 1.3s linear infinite;
    transition:width .15s linear;
  }
  @keyframes stripe{
    0%{background-position:0% 0}
    100%{background-position:200% 0}
  }

  .field-label{
    margin-top:22px;
    font-size:13px;
    color:rgba(230,240,255,.86);
    font-weight:800;
    letter-spacing:.02em;
  }

  input{
    width:100%;
    box-sizing:border-box;
    margin-top:10px;
    padding:13px 14px;
    border-radius:16px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.10);
    color:var(--text);
    font-family:ui-monospace,monospace;
    outline:none;
    transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  html[data-theme="light"] input{ background:rgba(255,255,255,.06); }
  input:focus{
    border-color:rgba(41,182,255,.35);
    box-shadow:0 0 0 4px rgba(41,182,255,.12);
  }
  input::placeholder{ color:rgba(159,176,200,.68); }

  .row{
    display:flex;
    gap:12px;
    margin-top:18px;
  }
  button{
    flex:1;
    height:46px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--panel2);
    color:var(--text);
    cursor:pointer;
    font-weight:900;
    letter-spacing:.02em;
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
  }
  button:hover{
    transform:translateY(-1px);
    box-shadow:0 18px 46px rgba(0,0,0,.30), 0 0 18px rgba(41,182,255,.14);
    border-color:rgba(41,182,255,.26);
    background:rgba(0,0,0,.16);
  }
  button.primary{
    border-color:transparent;
    background: linear-gradient(135deg, rgba(41,182,255,1), rgba(58,163,255,.92));
    color:#fff;
    box-shadow:0 18px 50px rgba(41,182,255,.18);
  }
  button.primary:hover{
    box-shadow:0 22px 60px rgba(41,182,255,.22), 0 0 22px rgba(41,182,255,.22);
  }

  .status{
    margin-top:10px;
    text-align:center;
    font-size:12px;
    min-height:18px;
  }
  .status.ok{color:#4cd18c;}
  .status.err{color:#ff6b6b;}

  .footer{
    margin-top:18px;
    text-align:center;
    color:var(--muted);
    font-size:12px;
    opacity:.85;
    user-select:none;
  }

  @media (max-width:760px){
    .nav-inner{ flex-direction:column; align-items:flex-start; }
    .controls{ width:100%; justify-content:flex-start; }
    .row{ flex-direction:column; }
    button{ width:100%; }
  }
</style>
</head>

<body>
  <div class="nav">
    <div class="container">
      <div class="nav-inner">
        <div class="brand">
          <img src="logo.png" alt="Logo" />
          <div>
            <div class="title" id="navTitle">Battle.net Authenticator</div>
            <div class="sub" id="navSub">Generate verification codes locally.</div>
          </div>
        </div>

        <div class="controls">
          <a class="pill" href="/" id="homeBtn" title="Back">üè†</a>

          <select id="langSelect" class="pill lang-select" title="Language">
            <option value="en">EN</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="fr">FR</option>
            <option value="de">DE</option>
            <option value="ru">RU</option>
            <option value="it">IT</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>

          <button class="pill" id="themeToggle" title="Theme">‚òÄÔ∏è</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="container">
      <div class="panel">
        <div class="panel-inner">
          <div class="title-row">
            <div class="title-left">
              <div class="t" id="titleText">Battle.net Authenticator</div>
            </div>
          </div>

          <div class="code" id="code">--------</div>
          <div class="hint" id="remain"></div>
          <div class="barwrap"><div class="bar" id="bar"></div></div>

          <div class="field-label" id="secretLabel">Please enter your Private Key!</div>
          <input id="secret" placeholder="Private Key" autocomplete="off" spellcheck="false" />

          <div class="row">
            <button class="primary" id="copy">Copy Code</button>
            <button id="clear">Clear Key</button>
          </div>

          <div class="status" id="status"></div>
          <div class="footer" id="footer"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const DIGITS = 8;
  const PERIOD = 30;

  const THEME_KEY = "theme-choice";
  const THEME_MODE_KEY = "theme-mode";
  const LANG_KEY  = "locale-choice";
  const $ = id => document.getElementById(id);

  const i18n = {
    en: {
      navTitle:"Battle.net Authenticator",
      navSub:"Generate verification codes locally.",
      title:"Battle.net Authenticator",
      secretLabel:"Please enter your Private Key!",
      placeholder:"Private Key",
      copy:"Copy Code",
      clear:"Clear Key",
      copied:"Copied",
      copyBlocked:"Copy blocked",
      enterKeyError:"Enter Your Private Key",
      invalidKey:"Invalid Private Key",
      footer:"¬© {year} Roshine ‚Äî Overwatch Store. All rights reserved."
    },
    zh: {
      navTitle:"ÊàòÁΩëÂÆâÂÖ®‰ª§",
      navSub:"Êú¨Âú∞ÁîüÊàêÈ™åËØÅÁ†ÅÔºà‰∏ç‰∏ä‰º†Ôºâ„ÄÇ",
      title:"ÊàòÁΩëÂÆâÂÖ®‰ª§",
      secretLabel:"ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂÆâÂÖ®‰ª§ÁßòÈí•ÔºÅ",
      placeholder:"ÂÆâÂÖ®‰ª§ÁßòÈí•",
      copy:"Â§çÂà∂È™åËØÅÁ†Å",
      clear:"Ê∏ÖÁ©∫ÁßòÈí•",
      copied:"Â∑≤Â§çÂà∂È™åËØÅÁ†Å",
      copyBlocked:"ÊµèËßàÂô®Á¶ÅÊ≠¢Â§çÂà∂",
      enterKeyError:"ËØ∑ËæìÂÖ•ÂÆâÂÖ®‰ª§ÁßòÈí•",
      invalidKey:"Êó†ÊïàÁöÑÂÆâÂÖ®‰ª§ÁßòÈí•",
      footer:"¬© {year} Roshine ‚Äî Overwatch ÂïÜÂ∫ó„ÄÇ‰øùÁïôÊâÄÊúâÊùÉÂà©„ÄÇ"
    },
    fr: {
      navTitle:"Jeton Battle.net",
      navSub:"G√©n√©ration locale des codes.",
      title:"Jeton de s√©curit√© Battle.net",
      secretLabel:"Veuillez entrer votre cl√© secr√®te !",
      placeholder:"Cl√© secr√®te",
      copy:"Copier le code",
      clear:"Effacer la cl√©",
      copied:"Code copi√©",
      copyBlocked:"Copie bloqu√©e",
      enterKeyError:"Veuillez entrer la cl√©",
      invalidKey:"Cl√© invalide",
      footer:"¬© {year} Roshine ‚Äî Boutique Overwatch."
    },
    de: {
      navTitle:"Battle.net Token",
      navSub:"Codes lokal erzeugen.",
      title:"Battle.net-Sicherheitstoken",
      secretLabel:"Bitte gib deinen Schl√ºssel ein!",
      placeholder:"Sicherheitsschl√ºssel",
      copy:"Code kopieren",
      clear:"Schl√ºssel l√∂schen",
      copied:"Code kopiert",
      copyBlocked:"Kopieren blockiert",
      enterKeyError:"Bitte Schl√ºssel eingeben",
      invalidKey:"Ung√ºltiger Schl√ºssel",
      footer:"¬© {year} Roshine ‚Äî Overwatch-Shop."
    },
    ru: {
      navTitle:"–¢–æ–∫–µ–Ω Battle.net",
      navSub:"–ö–æ–¥—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.",
      title:"–¢–æ–∫–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Battle.net",
      secretLabel:"–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á —Ç–æ–∫–µ–Ω–∞!",
      placeholder:"–ö–ª—é—á —Ç–æ–∫–µ–Ω–∞",
      copy:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
      clear:"–û—á–∏—Å—Ç–∏—Ç—å –∫–ª—é—á",
      copied:"–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω",
      copyBlocked:"–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ",
      enterKeyError:"–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á",
      invalidKey:"–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª—é—á",
      footer:"¬© {year} Roshine ‚Äî –º–∞–≥–∞–∑–∏–Ω Overwatch."
    },
    it: {
      navTitle:"Token Battle.net",
      navSub:"Codici generati localmente.",
      title:"Token di sicurezza Battle.net",
      secretLabel:"Inserisci la chiave del token!",
      placeholder:"Chiave token",
      copy:"Copia codice",
      clear:"Cancella chiave",
      copied:"Codice copiato",
      copyBlocked:"Copia bloccata",
      enterKeyError:"Inserisci la chiave",
      invalidKey:"Chiave non valida",
      footer:"¬© {year} Roshine ‚Äî Negozio Overwatch."
    },
    ar: {
      navTitle:"ŸÖŸèÿµÿØŸëŸêŸÇ Battle.net",
      navSub:"ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ±ŸÖŸàÿ≤ ŸÖÿ≠ŸÑŸäÿßŸã.",
      title:"ÿ±ŸÖÿ≤ ÿ£ŸÖÿßŸÜ Battle.net",
      secretLabel:"Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖŸÅÿ™ÿßÿ≠ŸÉ!",
      placeholder:"ÿßŸÑŸÖŸÅÿ™ÿßÿ≠",
      copy:"ŸÜÿ≥ÿÆ ÿßŸÑÿ±ŸÖÿ≤",
      clear:"ŸÖÿ≥ÿ≠ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠",
      copied:"ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ",
      copyBlocked:"ÿßŸÑŸÜÿ≥ÿÆ ÿ∫Ÿäÿ± ŸÖÿ≥ŸÖŸàÿ≠",
      enterKeyError:"ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠",
      invalidKey:"ŸÖŸÅÿ™ÿßÿ≠ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠",
      footer:"¬© {year} Roshine ‚Äî ŸÖÿ™ÿ¨ÿ± ÿ£ŸàŸÅÿ±Ÿàÿßÿ™ÿ¥."
    }
  };

  let currentLang = "en";
  const t = key => (i18n[currentLang] && i18n[currentLang][key]) || (i18n.en[key] || key);

  function detectLang(){
    const saved = localStorage.getItem(LANG_KEY);
    if (saved && i18n[saved]) return saved;
    const nav = (navigator.language || "en").toLowerCase();
    if (nav.startsWith("zh")) return "zh";
    if (nav.startsWith("fr")) return "fr";
    if (nav.startsWith("de")) return "de";
    if (nav.startsWith("ru")) return "ru";
    if (nav.startsWith("it")) return "it";
    if (nav.startsWith("ar")) return "ar";
    return "en";
  }

  function applyLang(lang){
    if (!i18n[lang]) lang = "en";
    currentLang = lang;

    document.documentElement.lang = lang;
    document.documentElement.dir  = (lang === "ar" ? "rtl" : "ltr");

    const sel = $("langSelect");
    if (sel) sel.value = lang;

    $("navTitle").textContent = t("navTitle");
    $("navSub").textContent   = t("navSub");
    $("titleText").textContent   = t("title");
    $("secretLabel").textContent = t("secretLabel");
    $("secret").placeholder      = t("placeholder");
    $("copy").textContent        = t("copy");
    $("clear").textContent       = t("clear");

    const year = new Date().getFullYear();
    $("footer").textContent = t("footer").replace("{year}", year);
  }

  (function initLang(){
    applyLang(detectLang());
  })();

  $("langSelect").addEventListener("change", e => {
    const lang = e.target.value;
    applyLang(lang);
    localStorage.setItem(LANG_KEY, lang);
  });

  // Theme
  function getSystemTheme(){
    const prefersDark = window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    return prefersDark ? "dark" : "light";
  }
  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    const btn = $("themeToggle");
    if (!btn) return;
    btn.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
  }

  (function initTheme(){
    let mode  = localStorage.getItem(THEME_MODE_KEY);
    let theme = localStorage.getItem(THEME_KEY);

    if (!mode){
      mode = "system";
      theme = getSystemTheme();
      localStorage.setItem(THEME_MODE_KEY, mode);
      localStorage.setItem(THEME_KEY, theme);
    }else{
      if (mode === "system"){
        theme = getSystemTheme();
        localStorage.setItem(THEME_KEY, theme);
      }else if (!theme){
        theme = mode === "dark" ? "dark" : "light";
        localStorage.setItem(THEME_KEY, theme);
      }
    }
    applyTheme(theme);

    if (window.matchMedia){
      const mq = window.matchMedia("(prefers-color-scheme: dark)");
      mq.addEventListener("change", e => {
        const currentMode = localStorage.getItem(THEME_MODE_KEY) || "system";
        if (currentMode !== "system") return;
        const nextTheme = e.matches ? "dark" : "light";
        localStorage.setItem(THEME_KEY, nextTheme);
        applyTheme(nextTheme);
      });
    }
  })();

  $("themeToggle").addEventListener("click", () => {
    let mode  = localStorage.getItem(THEME_MODE_KEY) || "system";
    let theme = localStorage.getItem(THEME_KEY) || getSystemTheme();

    if (mode === "system"){ mode  = "dark";  theme = "dark"; }
    else if (mode === "dark"){ mode = "light"; theme = "light"; }
    else { mode = "system"; theme = getSystemTheme(); }

    localStorage.setItem(THEME_MODE_KEY, mode);
    localStorage.setItem(THEME_KEY, theme);
    applyTheme(theme);
  });

  // ===== TOTP =====
  function getKeyFromURL(){
    const u = new URL(location.href);
    const paramKey = u.searchParams.get("key");
    if (paramKey && /^[0-9a-fA-F]+$/.test(paramKey)) return paramKey;

    const parts = u.pathname.split("/").filter(Boolean);
    if (parts.length){
      const last = parts[parts.length - 1];
      if (/^[0-9a-fA-F]+$/.test(last)) return last;
    }
    return null;
  }

  function hexToBytes(s){
    s = s.trim().replace(/^0x/i,"").replace(/[^0-9a-f]/ig,"");
    if (!s) throw new Error("ERR_EMPTY_KEY");
    if (s.length % 2) throw new Error("ERR_INVALID_KEY");
    return Uint8Array.from(s.match(/../g).map(x => parseInt(x,16)));
  }
  function counterBytes(c){
    const b = new Uint8Array(8); let x = BigInt(c);
    for (let i = 7; i >= 0; i--){
      b[i] = Number(x & 0xffn);
      x >>= 8n;
    }
    return b;
  }
  async function hmacSha1(key,msg){
    const k = await crypto.subtle.importKey(
      "raw", key, {name:"HMAC", hash:"SHA-1"}, false, ["sign"]
    );
    return new Uint8Array(await crypto.subtle.sign("HMAC",k,msg));
  }
  function truncate(mac){
    const o = mac[mac.length - 1] & 0x0f;
    return (((mac[o]   & 0x7f) << 24) |
            ((mac[o+1] & 0xff) << 16) |
            ((mac[o+2] & 0xff) << 8)  |
            ( mac[o+3] & 0xff)) >>> 0;
  }
  function fmt(n){
    const raw = (n % (10**DIGITS)).toString().padStart(DIGITS, "0");
    return raw.slice(0,4) + " " + raw.slice(4);
  }

  async function gen(){
    const statusEl = $("status");
    try{
      const key = hexToBytes($("secret").value);
      const ctr = Math.floor(Date.now()/1000 / PERIOD);
      const mac = await hmacSha1(key, counterBytes(ctr));
      $("code").textContent = fmt(truncate(mac));
      if (statusEl){
        statusEl.textContent = "";
        statusEl.classList.remove("err","ok");
      }
    }catch(e){
      $("code").textContent = "--------";
      if (!statusEl) return;
      let msg;
      if (e.message === "ERR_EMPTY_KEY") msg = t("enterKeyError");
      else if (e.message === "ERR_INVALID_KEY") msg = t("invalidKey");
      else msg = e.message;
      statusEl.textContent = msg;
      statusEl.classList.add("err");
      statusEl.classList.remove("ok");
    }
  }

  function tick(){
    const s   = Math.floor(Date.now()/1000);
    const rem = PERIOD - (s % PERIOD);
    $("remain").textContent = `${rem}s`;
    $("bar").style.width    = ((PERIOD - rem) / PERIOD * 100) + "%";
  }

  let last = -1;
  setInterval(() => {
    tick();
    const s = Math.floor(Date.now()/1000);
    if (s !== last){
      last = s;
      gen();
    }
  }, 150);

  $("secret").addEventListener("input", gen);

  $("copy").addEventListener("click", async () => {
    const v = $("code").textContent;
    const statusEl = $("status");
    if (v.includes("-")) return;
    try{
      await navigator.clipboard.writeText(v.replace(/\s/g,""));
      if (statusEl){
        statusEl.textContent = t("copied");
        statusEl.classList.remove("err");
        statusEl.classList.add("ok");
      }
    }catch{
      if (statusEl){
        statusEl.textContent = t("copyBlocked");
        statusEl.classList.remove("ok");
        statusEl.classList.add("err");
      }
    }
  });

  $("clear").addEventListener("click", () => {
    $("secret").value = "";
    $("code").textContent = "--------";
    const statusEl = $("status");
    if (statusEl){
      statusEl.textContent = "";
      statusEl.classList.remove("err","ok");
    }
  });

  const urlKey = getKeyFromURL();
  if (urlKey) $("secret").value = urlKey;

  tick();
  gen();
</script>
</body>
</html>
