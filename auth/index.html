<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roshine ‚Äî Authenticator</title>
  <link rel="icon" href="/assets/logo.png" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap">

  <style>
    :root{
      /* ===== SAME TOKENS AS STORE (glass + sci-fi blue) ===== */
      --bg-dark:#05060b;
      --text-dark:#e6f0ff;
      --muted-dark:#7c8aaa;
      --accent-dark:#29b6ff;

      --bg-light:#171920;
      --text-light:#e4e7f5;
      --muted-light:#8b94aa;
      --accent-light:#3aa3ff;

      --bg:var(--bg-dark);
      --text:var(--text-dark);
      --muted:var(--muted-dark);
      --accent:var(--accent-dark);

      --glass-bg: rgba(15, 18, 26, .46);
      --glass-border: rgba(130, 170, 255, .18);
      --glass-shadow: 0 30px 90px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.06) inset;

      --radius-xl: 28px;
      --radius-lg: 20px;
      --radius-pill: 999px;

      --wrap: 980px;
    }

    html[data-theme="dark"]{
      --bg:var(--bg-dark);
      --text:var(--text-dark);
      --muted:var(--muted-dark);
      --accent:var(--accent-dark);
      --glass-bg: rgba(15, 18, 26, .46);
      --glass-border: rgba(130, 170, 255, .18);
    }
    html[data-theme="light"]{
      --bg:var(--bg-light);
      --text:var(--text-light);
      --muted:var(--muted-light);
      --accent:var(--accent-light);
      --glass-bg: rgba(255, 255, 255, .14);
      --glass-border: rgba(0, 0, 0, .20);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:"Titillium Web",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:var(--bg);
      overflow-x:hidden;
    }

    /* ===== same background vibe as store ===== */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 18% 8%, rgba(41,182,255,.18), transparent 62%),
        radial-gradient(820px 480px at 82% 14%, rgba(58,163,255,.14), transparent 64%),
        radial-gradient(900px 700px at 55% 110%, rgba(41,182,255,.08), transparent 55%);
      opacity:.55;
      mix-blend-mode:screen;
      filter:saturate(1.05);
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.025),
          rgba(255,255,255,.025) 1px,
          transparent 1px,
          transparent 14px
        );
      opacity:.035;
    }

    .wrap{
      width:min(var(--wrap), 92vw);
      margin:0 auto;
      position:relative;
      z-index:1;
    }

    /* ===== NAV (match store: brand left, pills right, same colors) ===== */
    .nav{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,0));
    }
    html[data-theme="light"] .nav{
      background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0));
    }

    .nav-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:18px 0 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .brand img{
      width:40px;height:40px;border-radius:14px;
      box-shadow:0 14px 42px rgba(0,0,0,.45);
      flex:0 0 auto;
    }
    .brand .name{
      font-weight:900;
      letter-spacing:.10em;
      font-size:14px;
      white-space:nowrap;
    }
    .brand .sub{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      max-width:66ch;
      line-height:1.35;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      height:34px;
      padding:0 14px;
      border-radius:var(--radius-pill);
      border:1px solid var(--glass-border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:13px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.05) inset;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    html[data-theme="light"] .pill{ background: rgba(255,255,255,.10); }
    .pill:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 34px rgba(0,0,0,.45), 0 0 18px rgba(41,182,255,.16);
      background: rgba(0,0,0,.26);
    }
    html[data-theme="light"] .pill:hover{ background: rgba(255,255,255,.16); }

    .lang-select{
      appearance:none;
      -moz-appearance:none;
      -webkit-appearance:none;
      border:none;
      background:transparent;
      padding:0 18px;
      text-align:center;
      cursor:pointer;
      color:var(--text);
      font-weight:800;
    }
    .lang-select option{ background:#050b16; color:#e8eefc; }
    html[data-theme="light"] .lang-select option{ background:#1a1d26; color:#e4e7f5; }

    /* ===== MAIN ===== */
    main{
      min-height: calc(100vh - 86px);
      display:flex;
      align-items:center;
      padding: 22px 0 56px;
    }

    .panel{
      width: min(720px, 94vw);
      margin: 0 auto;
      border-radius: var(--radius-xl);
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      box-shadow: var(--glass-shadow);
      padding: 26px 22px 22px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position:relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(700px 260px at 30% 0%, rgba(41,182,255,.16), transparent 62%);
      opacity:.85;
      pointer-events:none;
    }

    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      position:relative;
      z-index:1;
      margin-bottom:12px;
    }
    .panel-title{
      font-weight:900;
      letter-spacing:.06em;
      font-size:14px;
      opacity:.95;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .badge{
      height:34px;
      padding:0 14px;
      border-radius:var(--radius-pill);
      border:1px solid var(--glass-border);
      background: rgba(0,0,0,.14);
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.30), 0 0 0 1px rgba(255,255,255,.05) inset;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      user-select:none;
      white-space:nowrap;
    }
    html[data-theme="light"] .badge{ background: rgba(255,255,255,.10); }

    .panel-note{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.7;
      position:relative;
      z-index:1;
    }

    .code{
      text-align:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: clamp(44px, 7.5vw, 78px);
      font-weight: 900;
      letter-spacing: 7px;
      margin: 18px 0 10px;
      position:relative;
      z-index:1;
    }

    .hint{
      text-align:center;
      font-size:13px;
      color:var(--muted);
      margin-bottom:14px;
      position:relative;
      z-index:1;
    }

    .barwrap{
      height: 12px;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(130,170,255,.14);
      background: rgba(0,0,0,.14);
      box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
      position:relative;
      z-index:1;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    html[data-theme="light"] .barwrap{ background: rgba(255,255,255,.10); }

    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(41,182,255,1), rgba(25,145,240,1));
      position:relative;
      overflow:hidden;
      transition: width .15s linear;
    }
    .bar::after{
      content:"";
      position:absolute; inset:-40% -60%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.38), transparent);
      transform: translateX(-30%);
      animation: sheen 1.4s linear infinite;
      opacity:.35;
    }
    @keyframes sheen{
      0%{ transform: translateX(-35%); }
      100%{ transform: translateX(35%); }
    }

    .field{ margin-top: 18px; position:relative; z-index:1; }
    .field-label{
      font-size:13px;
      font-weight:900;
      letter-spacing:.04em;
      color: rgba(230,240,255,.92);
      margin-bottom:8px;
    }
    html[data-theme="light"] .field-label{ color: rgba(25,30,42,.90); }

    input{
      width:100%;
      box-sizing:border-box;
      padding: 16px 14px;
      border-radius: 18px;
      border: 1px solid rgba(130,170,255,.18);
      background: rgba(0,0,0,.14);
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      outline:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    html[data-theme="light"] input{ background: rgba(255,255,255,.10); }
    input::placeholder{ color: rgba(160,178,210,.70); }
    html[data-theme="light"] input::placeholder{ color: rgba(90,98,120,.65); }

    .row{
      display:flex;
      gap:12px;
      margin-top: 14px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .btn{
      height:52px;
      padding: 0 16px;
      border-radius: 18px;
      border: 1px solid var(--glass-border);
      background: rgba(0,0,0,.14);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex: 1 1 220px;
      box-shadow: 0 18px 46px rgba(0,0,0,.38), 0 0 0 1px rgba(255,255,255,.05) inset;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      -webkit-tap-highlight-color: transparent;
    }
    html[data-theme="light"] .btn{ background: rgba(255,255,255,.10); }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 22px 56px rgba(0,0,0,.46), 0 0 22px rgba(41,182,255,.16);
      background: rgba(0,0,0,.20);
    }
    html[data-theme="light"] .btn:hover{ background: rgba(255,255,255,.16); }

    .btn.primary{
      border-color: transparent;
      color:#fff;
      background: linear-gradient(180deg, rgba(41,182,255,1), rgba(25,145,240,1));
      box-shadow: 0 22px 56px rgba(41,182,255,.18), 0 0 0 1px rgba(255,255,255,.10) inset;
    }
    .btn.primary:hover{
      box-shadow: 0 0 26px rgba(41,182,255,.42), 0 22px 56px rgba(41,182,255,.18);
      opacity:.98;
    }

    .status{
      margin-top:12px;
      min-height:18px;
      text-align:center;
      font-size:12px;
      position:relative;
      z-index:1;
    }
    .status.ok{ color:#4cd18c; }
    .status.err{ color:#ff6b6b; }

    .foot{
      margin-top:14px;
      text-align:center;
      color: var(--muted);
      font-size:12px;
      opacity:.88;
      user-select:none;
      position:relative;
      z-index:1;
    }

    /* ===== Mobile: same logic as store (not cramped) ===== */
    @media (max-width: 860px){
      .nav-inner{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      .controls{
        width:100%;
        justify-content:flex-start;
      }
    }

    @media (max-width: 560px){
      .wrap{ width:min(var(--wrap), 94vw); }
      .nav-inner{ padding:16px 0 12px; }

      .brand img{ width:38px;height:38px; }
      .brand .name{ font-size:13px; }
      .brand .sub{ max-width:46ch; }

      /* 3 items -> breathable grid like store */
      .controls{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:10px;
        align-items:stretch;
      }
      .pill{ width:100%; height:40px; }
      .lang-select{ padding:0 22px; }

      main{ padding: 16px 0 44px; }
      .panel{
        width: min(720px, 96vw);
        padding: 22px 16px 18px;
        border-radius: 24px;
      }

      .panel-head{
        flex-direction:column;
        align-items:flex-start;
        gap:10px;
      }
      .badge{ width:100%; justify-content:center; height:38px; }

      .code{
        letter-spacing: 4px;
        font-size: clamp(40px, 12vw, 58px);
      }

      .row{ flex-direction:column; }
      .btn{ width:100%; height:54px; }
    }

    @media (max-width: 360px){
      .controls{ grid-template-columns: 1fr; }
      .code{ letter-spacing: 3px; }
    }
  </style>
</head>

<body>
  <div class="nav">
    <div class="wrap">
      <div class="nav-inner">
        <div class="brand">
          <img src="/assets/logo.png" alt="Roshine Logo" />
          <div>
            <div class="name">ROSHINE.LOVE</div>
            <div class="sub" id="subText">Overwatch Account Store ‚Ä¢ Listings via Google Sheet ‚Ä¢ Purchase via Discord</div>
          </div>
        </div>

        <div class="controls">
          <select id="langSelect" class="pill lang-select" title="Language">
            <option value="en">EN</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="fr">FR</option>
            <option value="de">DE</option>
            <option value="ru">RU</option>
            <option value="it">IT</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>

          <button class="pill" id="themeToggle" title="Theme">‚òÄÔ∏è</button>
          <a class="pill" href="/" id="homeLink" title="Home">‚Üê <span id="homeText">Home</span></a>
        </div>
      </div>
    </div>
  </div>

  <main>
    <div class="wrap">
      <section class="panel" aria-label="Authenticator">
        <div class="panel-head">
          <div class="panel-title" id="titleText">üîê Battle.net Authenticator</div>
          <div class="badge" id="modeBadge">TOTP ‚Ä¢ 30s</div>
        </div>

        <p class="panel-note" id="descText">
          Paste your Private Key to generate the current verification code. Then copy the code into Battle.net.
        </p>

        <div class="code" id="code">--------</div>
        <div class="hint" id="remain"></div>
        <div class="barwrap"><div class="bar" id="bar"></div></div>

        <div class="field">
          <div class="field-label" id="secretLabel">Private Key</div>
          <input id="secret" placeholder="Private Key" autocomplete="off" spellcheck="false" />
        </div>

        <div class="row">
          <button class="btn primary" id="copy">üìã <span id="copyText">Copy Code</span></button>
          <button class="btn" id="clear">üßπ <span id="clearText">Clear Key</span></button>
        </div>

        <div class="status" id="status"></div>
        <div class="foot" id="footer"></div>
      </section>
    </div>
  </main>

  <script>
    // ===== TOTP =====
    const DIGITS = 8;
    const PERIOD = 30;

    const THEME_KEY = "theme-choice";
    const THEME_MODE_KEY = "theme-mode";
    const LANG_KEY  = "locale-choice";

    const $ = id => document.getElementById(id);

    // ===== i18n (keep consistent with store language set) =====
    const i18n = {
      en: {
        sub: "Overwatch Account Store ‚Ä¢ Listings via Google Sheet ‚Ä¢ Purchase via Discord",
        home: "Home",
        title: "üîê Battle.net Authenticator",
        desc: "Paste your Private Key to generate the current verification code. Then copy the code into Battle.net.",
        secretLabel: "Private Key",
        placeholder: "Private Key",
        copy: "Copy Code",
        clear: "Clear Key",
        copied: "Copied",
        copyBlocked: "Copy blocked",
        enterKeyError: "Enter your Private Key",
        invalidKey: "Invalid Private Key",
        footer: "¬© {year} Roshine.love ‚Äî Authenticator."
      },
      zh: {
        sub: "Overwatch Account Store ‚Ä¢ Google Sheet Â±ïÁ§∫Â∫ìÂ≠ò ‚Ä¢ Discord ËÅîÁ≥ªË¥≠‰π∞",
        home: "ËøîÂõû",
        title: "üîê ÊàòÁΩëÂÆâÂÖ®‰ª§",
        desc: "Á≤òË¥¥‰Ω†ÁöÑÂÆâÂÖ®‰ª§ÁßòÈí•ÁîüÊàêÂΩìÂâçÈ™åËØÅÁ†ÅÔºåÁÑ∂ÂêéÂ§çÂà∂Âà∞ Battle.net ‰ΩøÁî®„ÄÇ",
        secretLabel: "ÂÆâÂÖ®‰ª§ÁßòÈí•",
        placeholder: "ÂÆâÂÖ®‰ª§ÁßòÈí•",
        copy: "Â§çÂà∂È™åËØÅÁ†Å",
        clear: "Ê∏ÖÁ©∫ÁßòÈí•",
        copied: "Â∑≤Â§çÂà∂È™åËØÅÁ†Å",
        copyBlocked: "ÊµèËßàÂô®Á¶ÅÊ≠¢Â§çÂà∂",
        enterKeyError: "ËØ∑ËæìÂÖ•ÂÆâÂÖ®‰ª§ÁßòÈí•",
        invalidKey: "Êó†ÊïàÁöÑÂÆâÂÖ®‰ª§ÁßòÈí•",
        footer: "¬© {year} Roshine.love ‚Äî ÂÆâÂÖ®‰ª§Â∑•ÂÖ∑„ÄÇ"
      },
      fr: {
        sub: "Boutique de comptes Overwatch ‚Ä¢ Liste via Google Sheet ‚Ä¢ Achat via Discord",
        home: "Accueil",
        title: "üîê Jeton Battle.net",
        desc: "Collez votre cl√© priv√©e pour g√©n√©rer le code, puis copiez-le dans Battle.net.",
        secretLabel: "Cl√© priv√©e",
        placeholder: "Cl√© priv√©e",
        copy: "Copier le code",
        clear: "Effacer la cl√©",
        copied: "Code copi√©",
        copyBlocked: "Copie bloqu√©e",
        enterKeyError: "Entrez votre cl√© priv√©e",
        invalidKey: "Cl√© priv√©e invalide",
        footer: "¬© {year} Roshine.love ‚Äî Jeton."
      },
      de: {
        sub: "Overwatch Account Shop ‚Ä¢ Liste via Google Sheet ‚Ä¢ Kauf √ºber Discord",
        home: "Start",
        title: "üîê Battle.net-Token",
        desc: "F√ºge deinen Private Key ein, generiere den Code und kopiere ihn in Battle.net.",
        secretLabel: "Private Key",
        placeholder: "Private Key",
        copy: "Code kopieren",
        clear: "Key l√∂schen",
        copied: "Kopiert",
        copyBlocked: "Kopieren blockiert",
        enterKeyError: "Private Key eingeben",
        invalidKey: "Ung√ºltiger Private Key",
        footer: "¬© {year} Roshine.love ‚Äî Token."
      },
      ru: {
        sub: "–ú–∞–≥–∞–∑–∏–Ω –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Overwatch ‚Ä¢ –°–ø–∏—Å–æ–∫ –≤ Google Sheet ‚Ä¢ –ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Discord",
        home: "–î–æ–º–æ–π",
        title: "üîê –¢–æ–∫–µ–Ω Battle.net",
        desc: "–í—Å—Ç–∞–≤—å—Ç–µ Private Key, –ø–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ Battle.net.",
        secretLabel: "Private Key",
        placeholder: "Private Key",
        copy: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
        clear: "–û—á–∏—Å—Ç–∏—Ç—å –∫–ª—é—á",
        copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",
        copyBlocked: "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ",
        enterKeyError: "–í–≤–µ–¥–∏—Ç–µ Private Key",
        invalidKey: "–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π Private Key",
        footer: "¬© {year} Roshine.love ‚Äî —Ç–æ–∫–µ–Ω."
      },
      it: {
        sub: "Negozio account Overwatch ‚Ä¢ Lista su Google Sheet ‚Ä¢ Acquisto via Discord",
        home: "Home",
        title: "üîê Token Battle.net",
        desc: "Incolla il Private Key per generare il codice e copialo in Battle.net.",
        secretLabel: "Private Key",
        placeholder: "Private Key",
        copy: "Copia codice",
        clear: "Cancella key",
        copied: "Copiato",
        copyBlocked: "Copia bloccata",
        enterKeyError: "Inserisci Private Key",
        invalidKey: "Private Key non valido",
        footer: "¬© {year} Roshine.love ‚Äî Token."
      },
      ar: {
        sub: "ŸÖÿ™ÿ¨ÿ± ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ£ŸàŸÅÿ±Ÿàÿßÿ™ÿ¥ ‚Ä¢ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπÿ®ÿ± Google Sheet ‚Ä¢ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿπÿ®ÿ± Discord",
        home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
        title: "üîê ŸÖŸèÿµÿØŸëŸêŸÇ Battle.net",
        desc: "ÿ£ŸÑÿµŸÇ Private Key ŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ±ŸÖÿ≤ ÿ´ŸÖ ÿßŸÜÿ≥ÿÆŸá ÿ•ŸÑŸâ Battle.net.",
        secretLabel: "Private Key",
        placeholder: "Private Key",
        copy: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ŸÖÿ≤",
        clear: "ŸÖÿ≥ÿ≠ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠",
        copied: "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ",
        copyBlocked: "ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑŸÜÿ≥ÿÆ",
        enterKeyError: "ÿ£ÿØÿÆŸÑ Private Key",
        invalidKey: "Private Key ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠",
        footer: "¬© {year} Roshine.love ‚Äî ÿßŸÑŸÖŸèÿµÿØŸëŸêŸÇ."
      }
    };

    function detectLang(){
      const saved = localStorage.getItem(LANG_KEY);
      if (saved && i18n[saved]) return saved;

      const nav = (navigator.language || "en").toLowerCase();
      if (nav.startsWith("zh")) return "zh";
      if (nav.startsWith("fr")) return "fr";
      if (nav.startsWith("de")) return "de";
      if (nav.startsWith("ru")) return "ru";
      if (nav.startsWith("it")) return "it";
      if (nav.startsWith("ar")) return "ar";
      return "en";
    }

    let currentLang = "en";
    const t = (key) => (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;

    function applyLang(lang){
      if (!i18n[lang]) lang = "en";
      currentLang = lang;

      document.documentElement.lang = lang;
      document.documentElement.dir  = (lang === "ar" ? "rtl" : "ltr");

      const sel = $("langSelect");
      if (sel) sel.value = lang;

      $("subText").textContent = t("sub");
      $("homeText").textContent = t("home");
      $("titleText").textContent = t("title");
      $("descText").textContent = t("desc");
      $("secretLabel").textContent = t("secretLabel");
      $("secret").placeholder = t("placeholder");
      $("copyText").textContent = t("copy");
      $("clearText").textContent = t("clear");

      $("footer").textContent = t("footer").replace("{year}", new Date().getFullYear());
    }

    (function initLang(){
      applyLang(detectLang());
    })();

    $("langSelect").addEventListener("change", e => {
      const lang = e.target.value;
      applyLang(lang);
      localStorage.setItem(LANG_KEY, lang);
      if ($("status").classList.contains("err")) gen();
    });

    // ===== Theme (system -> dark -> light -> system) =====
    function getSystemTheme(){
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      return prefersDark ? "dark" : "light";
    }
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      const btn = $("themeToggle");
      if (btn) btn.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    }

    (function initTheme(){
      let mode  = localStorage.getItem(THEME_MODE_KEY);
      let theme = localStorage.getItem(THEME_KEY);

      if (!mode){
        mode = "system";
        theme = getSystemTheme();
        localStorage.setItem(THEME_MODE_KEY, mode);
        localStorage.setItem(THEME_KEY, theme);
      }else{
        if (mode === "system"){
          theme = getSystemTheme();
          localStorage.setItem(THEME_KEY, theme);
        }else if (!theme){
          theme = mode === "dark" ? "dark" : "light";
          localStorage.setItem(THEME_KEY, theme);
        }
      }
      applyTheme(theme);

      if (window.matchMedia){
        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        mq.addEventListener("change", e => {
          const currentMode = localStorage.getItem(THEME_MODE_KEY) || "system";
          if (currentMode !== "system") return;
          const nextTheme = e.matches ? "dark" : "light";
          localStorage.setItem(THEME_KEY, nextTheme);
          applyTheme(nextTheme);
        });
      }
    })();

    $("themeToggle").addEventListener("click", () => {
      let mode  = localStorage.getItem(THEME_MODE_KEY) || "system";
      let theme = localStorage.getItem(THEME_KEY) || getSystemTheme();

      if (mode === "system"){ mode = "dark"; theme = "dark"; }
      else if (mode === "dark"){ mode = "light"; theme = "light"; }
      else { mode = "system"; theme = getSystemTheme(); }

      localStorage.setItem(THEME_MODE_KEY, mode);
      localStorage.setItem(THEME_KEY, theme);
      applyTheme(theme);
    });

    // ===== URL key support (?key= or /hex) =====
    function getKeyFromURL(){
      const u = new URL(location.href);
      const paramKey = u.searchParams.get("key");
      if (paramKey && /^[0-9a-fA-F]+$/.test(paramKey)) return paramKey;

      const parts = u.pathname.split("/").filter(Boolean);
      if (parts.length){
        const last = parts[parts.length - 1];
        if (/^[0-9a-fA-F]+$/.test(last)) return last;
      }
      return null;
    }

    // ===== TOTP core =====
    function hexToBytes(s){
      s = s.trim().replace(/^0x/i,"").replace(/[^0-9a-f]/ig,"");
      if (!s) throw new Error("ERR_EMPTY_KEY");
      if (s.length % 2) throw new Error("ERR_INVALID_KEY");
      return Uint8Array.from(s.match(/../g).map(x => parseInt(x,16)));
    }
    function counterBytes(c){
      const b = new Uint8Array(8); let x = BigInt(c);
      for (let i = 7; i >= 0; i--){
        b[i] = Number(x & 0xffn);
        x >>= 8n;
      }
      return b;
    }
    async function hmacSha1(key,msg){
      const k = await crypto.subtle.importKey(
        "raw", key, {name:"HMAC", hash:"SHA-1"}, false, ["sign"]
      );
      return new Uint8Array(await crypto.subtle.sign("HMAC",k,msg));
    }
    function truncate(mac){
      const o = mac[mac.length - 1] & 0x0f;
      return (((mac[o]   & 0x7f) << 24) |
              ((mac[o+1] & 0xff) << 16) |
              ((mac[o+2] & 0xff) << 8)  |
              ( mac[o+3] & 0xff)) >>> 0;
    }
    function fmt(n){
      const raw = (n % (10**DIGITS)).toString().padStart(DIGITS, "0");
      return raw.slice(0,4) + " " + raw.slice(4);
    }

    async function gen(){
      const statusEl = $("status");
      try{
        const key = hexToBytes($("secret").value);
        const ctr = Math.floor(Date.now()/1000 / PERIOD);
        const mac = await hmacSha1(key, counterBytes(ctr));
        $("code").textContent = fmt(truncate(mac));
        if (statusEl){
          statusEl.textContent = "";
          statusEl.classList.remove("err","ok");
        }
      }catch(e){
        $("code").textContent = "--------";
        if (!statusEl) return;
        let msg;
        if (e.message === "ERR_EMPTY_KEY") msg = t("enterKeyError");
        else if (e.message === "ERR_INVALID_KEY") msg = t("invalidKey");
        else msg = e.message;
        statusEl.textContent = msg;
        statusEl.classList.add("err");
        statusEl.classList.remove("ok");
      }
    }

    function tick(){
      const s   = Math.floor(Date.now()/1000);
      const rem = PERIOD - (s % PERIOD);
      $("remain").textContent = `${rem}s`;
      $("bar").style.width    = ((PERIOD - rem) / PERIOD * 100) + "%";
    }

    let last = -1;
    setInterval(() => {
      tick();
      const s = Math.floor(Date.now()/1000);
      if (s !== last){
        last = s;
        gen();
      }
    }, 150);

    $("secret").addEventListener("input", gen);

    $("copy").addEventListener("click", async () => {
      const v = $("code").textContent;
      const statusEl = $("status");
      if (v.includes("-")) return;
      try{
        await navigator.clipboard.writeText(v.replace(/\s/g,""));
        if (statusEl){
          statusEl.textContent = t("copied");
          statusEl.classList.remove("err");
          statusEl.classList.add("ok");
        }
      }catch{
        if (statusEl){
          statusEl.textContent = t("copyBlocked");
          statusEl.classList.remove("ok");
          statusEl.classList.add("err");
        }
      }
    });

    $("clear").addEventListener("click", () => {
      $("secret").value = "";
      $("code").textContent = "--------";
      const statusEl = $("status");
      if (statusEl){
        statusEl.textContent = "";
        statusEl.classList.remove("err","ok");
      }
    });

    const urlKey = getKeyFromURL();
    if (urlKey) $("secret").value = urlKey;

    tick();
    gen();
  </script>
</body>
</html>
