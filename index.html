<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Battle.net Authenticator</title>
<link rel="icon" href="logo.png" />

<!-- ç§‘æŠ€æ„Ÿå­—ä½“ -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap">

<style>
:root{
  /* æ·±è‰²ä¸»é¢˜ï¼šå Warframe / Battle.net ç§‘å¹»è“ */
  --bg-dark:#05060b;          /* æ•´ä½“èƒŒæ™¯ï¼šæ¥è¿‘çº¯é»‘ */
  --card-dark:#0b1018;        /* å¡ç‰‡èƒŒæ™¯ï¼šæ·±è“é»‘ */
  --border-dark:#202736;      /* è¾¹æ¡†ï¼šå†·ç°è“ */
  --text-dark:#e6f0ff;        /* ä¸»æ–‡å­—ï¼šåå†·çš„ç™½ */
  --muted-dark:#7c8aaa;       /* æ¬¡è¦æ–‡å­—ï¼šç°è“ */
  --accent-dark:#29b6ff;      /* é«˜äº®è“ï¼šæˆ˜ç½‘æ„Ÿ */

  /* äº®è‰²ä¸»é¢˜ï¼šæš—ç°ç³»äº®è‰²ï¼Œä¸æ™ƒçœ¼ */
  --bg-light:#171920;         /* é¡µé¢èƒŒæ™¯ï¼šæ·±ä¸€ç‚¹çš„ç°è“ */
  --card-light:#1f222b;       /* å¡ç‰‡ï¼šæ¯”èƒŒæ™¯ç¨äº® */
  --border-light:#2c3140;     /* è¾¹æ¡†ï¼šä¸­ç°è“ */
  --text-light:#e4e7f5;       /* æ–‡å­—ï¼šæµ…ç°ç™½ */
  --muted-light:#8b94aa;      /* æ¬¡è¦æ–‡å­—ï¼šç°è“ */
  --accent-light:#3aa3ff;     /* é«˜äº®è“ï¼šæŸ”ä¸€ç‚¹ */

  /* å½“å‰å®é™…ä½¿ç”¨ï¼ˆç”± data-theme å†³å®šï¼‰ */
  --bg:var(--bg-dark);
  --card:var(--card-dark);
  --border:var(--border-dark);
  --text:var(--text-dark);
  --muted:var(--muted-dark);
  --accent:var(--accent-dark);
}

html[data-theme="dark"]{
  --bg:var(--bg-dark);
  --card:var(--card-dark);
  --border:var(--border-dark);
  --text:var(--text-dark);
  --muted:var(--muted-dark);
  --accent:var(--accent-dark);
}
html[data-theme="light"]{
  --bg:var(--bg-light);
  --card:var(--card-light);
  --border:var(--border-light);
  --text:var(--text-light);
  --muted:var(--muted-light);
  --accent:var(--accent-light);
}

html,body{height:100%}
body{
  margin:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  color:var(--text);
  font-family:"Titillium Web",system-ui,-apple-system,Segoe UI,Roboto,Arial;
}

/* æš—è‰²ï¼šé»‘ / æ·±è“ç°æ¸å˜ */
html[data-theme="dark"] body{
  background:
    radial-gradient(circle at 50% -10%, #161b27 0%, #05060b 65%, #000000 100%);
}

/* äº®è‰²ï¼šæš—ç°èƒŒæ™¯ï¼Œä¸­å¿ƒç¨äº® */
html[data-theme="light"] body{
  background:
    radial-gradient(circle at 50% -10%, #262a35 0%, #171920 65%, #10121a 100%);
}

/* å¡ç‰‡æ•´ä½“æ›´å¤§ */
.wrap{
  width:min(640px,96vw);
}

.card{
  position:relative;
  background:var(--card);
  border-radius:24px;
  padding:36px 30px 28px;
  box-shadow:0 22px 52px rgba(0,0,0,.55);
  overflow:hidden;
  transition:transform .18s ease, box-shadow .18s ease;
}
.card::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  padding:1px;
  background:linear-gradient(135deg,
    rgba(0,185,255,.8),
    rgba(0,110,255,.65),
    rgba(0,40,120,.7));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
          mask-composite:exclude;
  opacity:.75;
  pointer-events:none;
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 28px 66px rgba(0,0,0,.78);
}

.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:26px;
}
.top-left{
  display:flex;
  gap:12px;
  align-items:center;
}
.top-right{
  display:flex;
  align-items:center;
  gap:12px;
}

.logo-img{
  width:40px;height:40px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.45);
  transition:transform .18s ease, box-shadow .18s ease;
}
.logo-img:hover{
  transform:translateY(-1px);
  box-shadow:0 0 18px rgba(35,168,255,.9);
}

.title{
  font-weight:700;
  font-size:18px;
  letter-spacing:.03em;
  white-space:nowrap;
}

/* é¡¶éƒ¨æ§åˆ¶ç»Ÿä¸€é£æ ¼ï¼šEN / ğŸŒ™ / èœå• */
.top-control{
  min-width:52px;
  height:32px;
  padding:0 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  color:var(--text);
  font-size:13px;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 8px 18px rgba(0,0,0,.45);
  cursor:pointer;
  transition:
    background .15s ease,
    box-shadow .15s ease,
    transform .15s ease,
    opacity .15s ease;
}
html[data-theme="light"] .top-control{
  border-color:rgba(0,0,0,.55);
  background:rgba(0,0,0,.30);
  box-shadow:0 8px 18px rgba(0,0,0,.65);
}

.top-control:hover{
  background:rgba(0,0,0,.4);
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(0,0,0,.75);
}

/* è¯­è¨€é€‰æ‹©ï¼šå¤–è§‚è·Ÿç€ top-controlï¼Œéšè—åŸç”Ÿæ ·å¼ */
.lang-select{
  appearance:none;
  -moz-appearance:none;
  -webkit-appearance:none;
  border:none;
  background:transparent;
  padding:0 18px;
  text-align:center;
}

/* ä¸‹æ‹‰åˆ—è¡¨é¡¹é¢œè‰² */
.lang-select option{
  background:#050b16;
  color:#e8eefc;
}
html[data-theme="light"] .lang-select option{
  background:#1a1d26;
  color:#e4e7f5;
}

/* ä¸»é¢˜æŒ‰é’®ï¼šåªæ§åˆ¶å›¾æ ‡å¤§å°ï¼Œå…¶ä½™ç”± top-control ä¿è¯ */
.theme-toggle{
  border:none;
  background:transparent;
  padding:0;
  min-width:auto;
  font-size:18px;
}

/* ï¼ˆé¢„ç•™ï¼‰èœå•æŒ‰é’®ï¼šåŒæ ·é£æ ¼ */
.menu-toggle{
  border:none;
  background:transparent;
  padding:0;
  min-width:auto;
  font-size:16px;
}

/* éªŒè¯ç æ›´å¤§ä¸€äº› */
.code{
  text-align:center;
  font-family:ui-monospace,monospace;
  font-size:76px;
  font-weight:900;
  letter-spacing:7px;
  margin:32px 0 16px;
}

.hint{
  text-align:center;
  font-size:13px;
  color:var(--muted);
  margin-bottom:18px;
}
#remain{
  color:rgba(110,125,150,.9);
}

/* è¿›åº¦æ¡ */
.barwrap{
  height:12px;
  background:rgba(255,255,255,.08);
  border-radius:999px;
  overflow:hidden;
}
html[data-theme="light"] .barwrap{
  background:rgba(0,0,0,.35);
}
.bar{
  height:100%;
  width:0%;
  background:var(--accent);
  background-image:linear-gradient(90deg,
    rgba(255,255,255,.4),
    rgba(255,255,255,.9),
    rgba(255,255,255,.4));
  background-size:200% 100%;
  animation:stripe 1.3s linear infinite;
  transition:width .15s linear;
}
@keyframes stripe{
  0%{background-position:0% 0}
  100%{background-position:200% 0}
}

/* è¾“å…¥æç¤ºæ–‡æ¡ˆ */
.field-label{
  margin-top:30px;
  font-size:14px;
  color:rgba(200,210,235,.96);
  font-weight:600;
}
input{
  width:100%;
  box-sizing:border-box;
  margin-top:10px;
  padding:13px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.1);
  color:var(--text);
  font-family:ui-monospace,monospace;
}
html[data-theme="light"] input{
  background:rgba(255,255,255,.04);
}
input::placeholder{
  color:rgba(159,176,200,.7);
}
html[data-theme="light"] input::placeholder{
  color:rgba(180,190,210,.7);
}

/* æŒ‰é’®è¡Œæ•´ä½“æ›´å®½æ¾ */
.row{
  display:flex;
  gap:14px;
  justify-content:center;
  margin-top:26px;
}
button{
  padding:11px 18px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.08);
  color:var(--text);
  cursor:pointer;
  font-family:"Titillium Web",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  transition:background .15s ease, box-shadow .15s ease, transform .15s ease;
  min-width:120px;
}
button.primary{
  background:var(--accent);
  border-color:transparent;
  color:#fff;
}
button.primary:hover{
  box-shadow:0 0 16px rgba(35,168,255,.9);
  transform:translateY(-1px);
}
button:not(.primary):hover{
  box-shadow:0 0 10px rgba(35,168,255,.6);
  transform:translateY(-1px);
}

/* çŠ¶æ€æ–‡æ¡ˆ */
.status{
  margin-top:12px;
  text-align:center;
  font-size:12px;
  min-height:18px;
}
.status.ok{color:#4cd18c;}
.status.err{color:#ff6b6b;}

/* åº•éƒ¨ç‰ˆæƒ */
.footer{
  margin-top:20px;
  font-size:12px;
  color:var(--muted);
  text-align:center;
  user-select:none;
  opacity:.8;
}

/* æ‰‹æœºé€‚é… */
@media (max-width:480px){
  .wrap{
    width:92vw;
  }
  .card{
    padding:20px 14px 16px;
    border-radius:20px;
  }
  .title{font-size:15px}
  .code{
    font-size:clamp(36px,11vw,48px);
    letter-spacing:4px;
  }
  .row{
    flex-direction:column;
  }
  button{
    width:100%;
    min-width:0;
  }
  .logo-img{
    width:32px;height:32px;
    border-radius:12px;
  }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="top-left">
        <img src="logo.png" class="logo-img" alt="Battle.net Logo">
        <div class="title" id="titleText">Battle.net Authenticator</div>
      </div>
      <div class="top-right">
        <select id="langSelect" class="lang-select top-control">
          <option value="en">EN</option>
          <option value="zh">ä¸­æ–‡</option>
          <option value="fr">FR</option>
          <option value="de">DE</option>
          <option value="ru">RU</option>
          <option value="it">IT</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        </select>

        <button class="theme-toggle top-control" id="themeToggle">â˜€ï¸</button>

        <!-- é¢„ç•™èœå•æŒ‰é’®ç¤ºä¾‹ï¼ˆå¦‚æœå°†æ¥è¦ç”¨ï¼Œè§£å¼€æ³¨é‡Šï¼‰
        <button class="menu-toggle top-control" id="menuToggle">â˜°</button>
        -->
      </div>
    </div>

    <div class="code" id="code">--------</div>
    <div class="hint" id="remain"></div>
    <div class="barwrap"><div class="bar" id="bar"></div></div>

    <div class="field-label" id="secretLabel">Please enter your Private Key!</div>
    <input id="secret" placeholder="Private Key" autocomplete="off" spellcheck="false" />

    <div class="row">
      <button class="primary" id="copy">Copy Code</button>
      <button id="clear">Clear Key</button>
    </div>

    <div class="status" id="status"></div>
  </div>
</div>

<div class="footer" id="footer"></div>

<script>
const DIGITS = 8;
const PERIOD = 30;
const THEME_KEY = "theme-choice";       // å®é™… data-theme
const THEME_MODE_KEY = "theme-mode";    // system / light / dark
const LANG_KEY  = "locale-choice";
const $ = id => document.getElementById(id);

/* å¤šè¯­è¨€æ–‡æ¡ˆ */
const i18n = {
  en: {
    title: "Battle.net Authenticator",
    secretLabel: "Please enter your Private Key!",
    placeholder: "Private Key",
    copy: "Copy Code",
    clear: "Clear Key",
    copied: "Copied",
    copyBlocked: "Copy blocked",
    enterKeyError: "Enter Your Private Key",
    invalidKey: "Invalid Private Key",
    footer: "Â© {year} Roshine â€” Overwatch Store. All rights reserved."
  },
  zh: {
    title: "æˆ˜ç½‘å®‰å…¨ä»¤",
    secretLabel: "è¯·è¾“å…¥ä½ çš„å®‰å…¨ä»¤ç§˜é’¥ï¼",
    placeholder: "å®‰å…¨ä»¤ç§˜é’¥",
    copy: "å¤åˆ¶éªŒè¯ç ",
    clear: "æ¸…ç©ºç§˜é’¥",
    copied: "å·²å¤åˆ¶éªŒè¯ç ",
    copyBlocked: "æµè§ˆå™¨ç¦æ­¢å¤åˆ¶",
    enterKeyError: "è¯·è¾“å…¥å®‰å…¨ä»¤ç§˜é’¥",
    invalidKey: "æ— æ•ˆçš„å®‰å…¨ä»¤ç§˜é’¥",
    footer: "Â© {year} Roshine â€” Overwatch å•†åº—ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚"
  },
  fr: {
    title: "Jeton de sÃ©curitÃ© Battle.net",
    secretLabel: "Veuillez entrer votre clÃ© secrÃ¨te de sÃ©curitÃ© !",
    placeholder: "ClÃ© secrÃ¨te de sÃ©curitÃ©",
    copy: "Copier le code",
    clear: "Effacer la clÃ©",
    copied: "Code copiÃ©",
    copyBlocked: "Copie bloquÃ©e par le navigateur",
    enterKeyError: "Veuillez entrer votre clÃ© secrÃ¨te de sÃ©curitÃ©",
    invalidKey: "ClÃ© secrÃ¨te de sÃ©curitÃ© invalide",
    footer: "Â© {year} Roshine â€” Boutique Overwatch. Tous droits rÃ©servÃ©s."
  },
  de: {
    title: "Battle.net-Sicherheitstoken",
    secretLabel: "Bitte gib deinen SicherheitsschlÃ¼ssel ein!",
    placeholder: "SicherheitsschlÃ¼ssel",
    copy: "Code kopieren",
    clear: "SchlÃ¼ssel lÃ¶schen",
    copied: "Code kopiert",
    copyBlocked: "Kopieren vom Browser blockiert",
    enterKeyError: "Bitte gib deinen SicherheitsschlÃ¼ssel ein",
    invalidKey: "UngÃ¼ltiger SicherheitsschlÃ¼ssel",
    footer: "Â© {year} Roshine â€” Overwatch-Shop. Alle Rechte vorbehalten."
  },
  ru: {
    title: "Ğ¢Ğ¾ĞºĞµĞ½ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Battle.net",
    secretLabel: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸!",
    placeholder: "ĞšĞ»ÑÑ‡ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
    copy: "Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ´",
    clear: "ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡",
    copied: "ĞšĞ¾Ğ´ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½",
    copyBlocked: "Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‚Ğ¸Ğ» ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
    enterKeyError: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
    invalidKey: "ĞĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
    footer: "Â© {year} Roshine â€” Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Overwatch. Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹."
  },
  it: {
    title: "Token di sicurezza Battle.net",
    secretLabel: "Inserisci la chiave del tuo token di sicurezza!",
    placeholder: "Chiave token di sicurezza",
    copy: "Copia codice",
    clear: "Cancella chiave",
    copied: "Codice copiato",
    copyBlocked: "Copia bloccata dal browser",
    enterKeyError: "Inserisci la chiave del tuo token di sicurezza",
    invalidKey: "Chiave del token di sicurezza non valida",
    footer: "Â© {year} Roshine â€” Negozio Overwatch. Tutti i diritti riservati."
  },
  ar: {
    title: "Ø±Ù…Ø² Ø£Ù…Ø§Ù† Battle.net",
    secretLabel: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ!",
    placeholder: "Ù…ÙØªØ§Ø­ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù†",
    copy: "Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²",
    clear: "Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­",
    copied: "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²",
    copyBlocked: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ø³Ø®",
    enterKeyError: "Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù†",
    invalidKey: "Ù…ÙØªØ§Ø­ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† ØºÙŠØ± ØµØ§Ù„Ø­",
    footer: "Â© {year} Roshine â€” Ù…ØªØ¬Ø± Ø£ÙˆÙØ±ÙˆÙˆØªØ´. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©."
  }
};

let currentLang = "en";
const t = key => {
  const dict = i18n[currentLang] || i18n.en;
  return dict[key] || i18n.en[key] || key;
};

/* æ”¯æŒ ?key= å’Œ /hex ä¸¤ç§æ–¹å¼ */
function getKeyFromURL(){
  const u = new URL(location.href);
  const paramKey = u.searchParams.get("key");
  if (paramKey && /^[0-9a-fA-F]+$/.test(paramKey)) return paramKey;

  const parts = u.pathname.split("/").filter(Boolean);
  if (parts.length){
    const last = parts[parts.length - 1];
    if (/^[0-9a-fA-F]+$/.test(last)) return last;
  }
  return null;
}

/* è¯­è¨€åˆå§‹åŒ–ä¸åº”ç”¨ */
function applyLang(lang){
  if (!i18n[lang]) lang = "en";
  currentLang = lang;

  document.documentElement.lang = lang;
  document.documentElement.dir  = (lang === "ar" ? "rtl" : "ltr");

  const sel = $("langSelect");
  if (sel) sel.value = lang;

  $("titleText").textContent   = t("title");
  $("secretLabel").textContent = t("secretLabel");
  $("secret").placeholder      = t("placeholder");
  $("copy").textContent        = t("copy");
  $("clear").textContent       = t("clear");

  const year = new Date().getFullYear();
  $("footer").textContent = t("footer").replace("{year}", year);
}

(function initLang(){
  const saved = localStorage.getItem(LANG_KEY);
  let lang = saved;
  if (!lang){
    const nav = (navigator.language || navigator.userLanguage || "en").toLowerCase();
    if (nav.startsWith("zh")) lang = "zh";
    else if (nav.startsWith("fr")) lang = "fr";
    else if (nav.startsWith("de")) lang = "de";
    else if (nav.startsWith("ru")) lang = "ru";
    else if (nav.startsWith("it")) lang = "it";
    else if (nav.startsWith("ar")) lang = "ar";
    else lang = "en";
  }
  applyLang(lang);
})();

$("langSelect").addEventListener("change", e => {
  const lang = e.target.value;
  applyLang(lang);
  localStorage.setItem(LANG_KEY, lang);
});

/* ä¸»é¢˜åˆ‡æ¢ï¼šæŒ‰é’®æ˜¾ç¤ºâ€œå°†åˆ‡æ¢åˆ°çš„ä¸»é¢˜â€å›¾æ ‡ */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  const btn = $("themeToggle");
  if (!btn) return;
  btn.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
}

// æ ¹æ®ç³»ç»Ÿåå¥½è¿”å› "light" æˆ– "dark"
function getSystemTheme(){
  const prefersDark = window.matchMedia &&
    window.matchMedia("(prefers-color-scheme: dark)").matches;
  return prefersDark ? "dark" : "light";
}

// åˆå§‹åŒ–ä¸»é¢˜ & ç›‘å¬ç³»ç»Ÿå˜åŒ–ï¼ˆæ”¯æŒ system / light / dark ä¸‰ç§æ¨¡å¼ï¼‰
(function initTheme(){
  let mode  = localStorage.getItem(THEME_MODE_KEY);  // system / light / dark
  let theme = localStorage.getItem(THEME_KEY);       // å®é™… data-theme

  if (!mode){
    // ç¬¬ä¸€æ¬¡è®¿é—®ï¼šé»˜è®¤è·Ÿéšç³»ç»Ÿ
    mode = "system";
    theme = getSystemTheme();
    localStorage.setItem(THEME_MODE_KEY, mode);
    localStorage.setItem(THEME_KEY, theme);
  }else{
    // å·²ç»å­˜è¿‡ï¼šå¦‚æœæ˜¯ system å°±å†å–ä¸€ä¸‹å½“å‰ç³»ç»Ÿä¸»é¢˜
    if (mode === "system"){
      theme = getSystemTheme();
      localStorage.setItem(THEME_KEY, theme);
    }else if (!theme){
      // å®¹é”™ï¼šmode æœ‰ä½† theme æ²¡æœ‰
      theme = mode === "dark" ? "dark" : "light";
      localStorage.setItem(THEME_KEY, theme);
    }
  }

  applyTheme(theme);

  // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼šåªæœ‰åœ¨ mode === system æ—¶æ‰è‡ªåŠ¨åˆ‡
  if (window.matchMedia){
    const mq = window.matchMedia("(prefers-color-scheme: dark)");
    mq.addEventListener("change", e => {
      const currentMode = localStorage.getItem(THEME_MODE_KEY) || "system";
      if (currentMode !== "system") return;
      const nextTheme = e.matches ? "dark" : "light";
      localStorage.setItem(THEME_KEY, nextTheme);
      applyTheme(nextTheme);
    });
  }
})();

// ä¸‰æ€åˆ‡æ¢ï¼šsystem -> dark -> light -> system
$("themeToggle").addEventListener("click", () => {
  let mode  = localStorage.getItem(THEME_MODE_KEY) || "system";
  let theme = localStorage.getItem(THEME_KEY) || getSystemTheme();

  if (mode === "system"){
    mode  = "dark";
    theme = "dark";
  }else if (mode === "dark"){
    mode  = "light";
    theme = "light";
  }else{ // mode === "light"
    mode  = "system";
    theme = getSystemTheme();
  }

  localStorage.setItem(THEME_MODE_KEY, mode);
  localStorage.setItem(THEME_KEY, theme);
  applyTheme(theme);
});

/* TOTP é€»è¾‘ */
function hexToBytes(s){
  s = s.trim().replace(/^0x/i,"").replace(/[^0-9a-f]/ig,"");
  if (!s) throw new Error("ERR_EMPTY_KEY");
  if (s.length % 2) throw new Error("ERR_INVALID_KEY");
  return Uint8Array.from(s.match(/../g).map(x => parseInt(x,16)));
}
function counterBytes(c){
  const b = new Uint8Array(8); let x = BigInt(c);
  for (let i = 7; i >= 0; i--){
    b[i] = Number(x & 0xffn);
    x >>= 8n;
  }
  return b;
}
async function hmacSha1(key,msg){
  const k = await crypto.subtle.importKey(
    "raw", key, {name:"HMAC", hash:"SHA-1"}, false, ["sign"]
  );
  return new Uint8Array(await crypto.subtle.sign("HMAC",k,msg));
}
function truncate(mac){
  const o = mac[mac.length - 1] & 0x0f;
  return (((mac[o]   & 0x7f) << 24) |
          ((mac[o+1] & 0xff) << 16) |
          ((mac[o+2] & 0xff) << 8)  |
          ( mac[o+3] & 0xff)) >>> 0;
}
function fmt(n){
  const raw = (n % (10**DIGITS)).toString().padStart(DIGITS, "0");
  return raw.slice(0,4) + " " + raw.slice(4);
}

async function gen(){
  const statusEl = $("status");
  try{
    const key = hexToBytes($("secret").value);
    const ctr = Math.floor(Date.now()/1000 / PERIOD);
    const mac = await hmacSha1(key, counterBytes(ctr));
    $("code").textContent = fmt(truncate(mac));
    if (statusEl){
      statusEl.textContent = "";
      statusEl.classList.remove("err","ok");
    }
  }catch(e){
    $("code").textContent = "--------";
    if (!statusEl) return;
    let msg;
    if (e.message === "ERR_EMPTY_KEY") msg = t("enterKeyError");
    else if (e.message === "ERR_INVALID_KEY") msg = t("invalidKey");
    else msg = e.message;
    statusEl.textContent = msg;
    statusEl.classList.add("err");
    statusEl.classList.remove("ok");
  }
}

/* è¿›åº¦æ¡ & å‰©ä½™æ—¶é—´ */
function tick(){
  const s   = Math.floor(Date.now()/1000);
  const rem = PERIOD - (s % PERIOD);
  $("remain").textContent = `${rem}s`;
  $("bar").style.width    = ((PERIOD - rem) / PERIOD * 100) + "%";
}

let last = -1;
setInterval(() => {
  tick();
  const s = Math.floor(Date.now()/1000);
  if (s !== last){
    last = s;
    gen();
  }
}, 150);

/* è¾“å…¥ & æŒ‰é’®äº‹ä»¶ */
$("secret").addEventListener("input", gen);

$("copy").addEventListener("click", async () => {
  const v = $("code").textContent;
  const statusEl = $("status");
  if (v.includes("-")) return;
  try{
    await navigator.clipboard.writeText(v.replace(/\s/g,""));
    if (statusEl){
      statusEl.textContent = t("copied");
      statusEl.classList.remove("err");
      statusEl.classList.add("ok");
    }
  }catch{
    if (statusEl){
      statusEl.textContent = t("copyBlocked");
      statusEl.classList.remove("ok");
      statusEl.classList.add("err");
    }
  }
});

$("clear").addEventListener("click", () => {
  $("secret").value = "";
  $("code").textContent = "--------";
  const statusEl = $("status");
  if (statusEl){
    statusEl.textContent = "";
    statusEl.classList.remove("err","ok");
  }
});

/* åˆå§‹åŒ–ï¼šURL ä¸­æœ‰ key å°±é¢„å¡«ï¼ˆæ”¯æŒ ?key= ä¸ /hexï¼‰ */
const urlKey = getKeyFromURL();
if (urlKey){
  $("secret").value = urlKey;
}

tick();
gen();
</script>
</body>
</html>
